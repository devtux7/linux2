#!/bin/bash

# =============================================================================
# SSH DEÄÄ°ÅKENLERÄ°
# =============================================================================
readonly SSH_BAK_FILE="/etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)"
readonly SSH_CUSTOM_CONF="/etc/ssh/sshd_config.d/99-hardening.conf"

# =============================================================================
# SSH FONKSÄ°YONLARI
# =============================================================================

# SSH port ayarÄ±
configure_ssh_port() {
    print_message "\nğŸšª SSH PORT AYARI" "$CYAN"
    print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"

    CURRENT_PORT=$(sudo grep -E "^Port\s+" /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' || echo "22")
    print_message "Mevcut SSH Port: $CURRENT_PORT" "$YELLOW"

    while true; do
        read -p "Yeni SSH portu (22 veya 1024-65535, varsayÄ±lan: $CURRENT_PORT): " SSH_PORT
        SSH_PORT=${SSH_PORT:-$CURRENT_PORT}

        if [[ "$SSH_PORT" =~ ^[0-9]+$ ]] && [ "$SSH_PORT" -ge 22 ] && [ "$SSH_PORT" -le 65535 ]; then
            if [ "$SSH_PORT" -eq 22 ]; then
                print_message "â„¹ï¸  Port 22 (varsayÄ±lan SSH portu) kullanÄ±lacak." "$YELLOW"
                print_message "âš ï¸  Daha yÃ¼ksek gÃ¼venlik iÃ§in 1024-65535 arasÄ± bir port Ã¶nerilir." "$RED"
                read -p "22 portunu kullanmak istediÄŸinizden emin misiniz? (e/h): " confirm_port
                if [[ ! $confirm_port =~ ^[Ee]([Ee]vet)?$ ]]; then
                    continue
                fi
            elif [ "$SSH_PORT" -lt 1024 ] && [ "$SSH_PORT" -ne 22 ]; then
                print_message "âš ï¸  Port $SSH_PORT (1024'ten kÃ¼Ã§Ã¼k) seÃ§tiniz. Bu portlar sistem portlarÄ±dÄ±r." "$YELLOW"
                read -p "Port $SSH_PORT kullanmak istediÄŸinizden emin misiniz? (e/h): " confirm_port
                if [[ ! $confirm_port =~ ^[Ee]([Ee]vet)?$ ]]; then
                    continue
                fi
            fi
            break
        else
            print_message "âŒ GeÃ§ersiz port! 22 veya 1024-65535 arasÄ±nda olmalÄ±." "$RED"
        fi
    done

    print_message "âœ… SSH portu $SSH_PORT olarak ayarlandÄ±" "$GREEN"
    log_message "SSH portu $SSH_PORT olarak ayarlandÄ±"
}

# SSH yapÄ±landÄ±rmasÄ±
configure_ssh() {
    print_message "\nğŸ”§ SSH KONFÄ°GÃœRASYONU" "$CYAN"
    print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"

    # SSH config dizinini oluÅŸtur
    sudo mkdir -p /etc/ssh/sshd_config.d

    # Mevcut config'i yedekle
    if [[ -f /etc/ssh/sshd_config ]]; then
        sudo cp /etc/ssh/sshd_config "$SSH_BAK_FILE"
        print_message "ğŸ“‹ SSH config yedeklendi: $SSH_BAK_FILE" "$GREEN"
    fi

    # Kimlik doÄŸrulama yÃ¶ntemi seÃ§imi
    print_message "\nğŸ” KÄ°MLÄ°K DOÄRULAMA YÃ–NTEMÄ°" "$BLUE"
    echo ""
    echo "1) ğŸ”“ Parola ile giriÅŸ (Ã¶nerilmez, gÃ¼venlik: â­)"
    echo "2) ğŸ” Parola + 2FA ile giriÅŸ (Ã¶nemli, gÃ¼venlik: â­â­)"
    echo "3) ğŸ”‘ SSH AnahtarÄ± ile giriÅŸ (Ã¶nerilir, gÃ¼venlik: â­â­â­â­)"
    echo "4) ğŸ›¡ï¸  SSH AnahtarÄ± + 2FA ile giriÅŸ (tavsiye edilen, gÃ¼venlik: â­â­â­â­â­)"
    echo ""

    while true; do
        read -p "SeÃ§iminiz (1/2/3/4): " AUTH_CHOICE
        
        # Bu deÄŸiÅŸkeni global olarak kullanacaÄŸÄ±z (module scope)
        # DiÄŸer fonksiyonlardan eriÅŸilebilmesi iÃ§in export ediyoruz veya global varsayÄ±yoruz.
        # En iyisi Ã§aÄŸÄ±rÄ±ldÄ±ÄŸÄ± yerde source edildiÄŸi iÃ§in global kalÄ±r.
        
        case $AUTH_CHOICE in
            1)
                AUTH_METHOD="Parola"
                SECURITY_LEVEL="â­"
                PASSWORD_AUTH="yes"
                PUBKEY_AUTH="no"
                ;;
            2)
                AUTH_METHOD="Parola + 2FA"
                SECURITY_LEVEL="â­â­"
                PASSWORD_AUTH="yes"
                PUBKEY_AUTH="no"
                ;;
            3)
                AUTH_METHOD="SSH AnahtarÄ±"
                SECURITY_LEVEL="â­â­â­â­"
                PASSWORD_AUTH="no"
                PUBKEY_AUTH="yes"
                ;;
            4)
                AUTH_METHOD="SSH AnahtarÄ± + 2FA"
                SECURITY_LEVEL="â­â­â­â­â­"
                PASSWORD_AUTH="no"  # 4. seÃ§enekte PAROLA KAPALI
                PUBKEY_AUTH="yes"
                ;;
            *)
                print_message "âŒ GeÃ§ersiz seÃ§im!" "$RED"
                continue
                ;;
        esac
        break
    done

    print_message "\nâœ… SeÃ§ilen yÃ¶ntem: $AUTH_METHOD ($SECURITY_LEVEL)" "$GREEN"

    # Ã–zel SSH config dosyasÄ±nÄ± oluÅŸtur
    sudo tee "$SSH_CUSTOM_CONF" > /dev/null << EOF
# SSH Hardening Configuration
# Generated on $(date)
# DO NOT EDIT THIS FILE MANUALLY

Port $SSH_PORT
Protocol 2
PermitRootLogin no
MaxAuthTries 3
MaxSessions 3
ClientAliveInterval 300
ClientAliveCountMax 2
LoginGraceTime 120
StrictModes yes
X11Forwarding no
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
UsePAM yes
UseDNS no
Compression no
AllowGroups sshusers
PasswordAuthentication $PASSWORD_AUTH
PubkeyAuthentication $PUBKEY_AUTH
ChallengeResponseAuthentication yes
EOF

    # AuthenticationMethods ayarÄ±
    case $AUTH_CHOICE in
        1)
            # Sadece parola
            echo "AuthenticationMethods password" | sudo tee -a "$SSH_CUSTOM_CONF" > /dev/null
            ;;
        2)
            # Parola + 2FA (Ã¶nce parola, sonra 2FA)
            echo "AuthenticationMethods password,keyboard-interactive" | sudo tee -a "$SSH_CUSTOM_CONF" > /dev/null
            ;;
        3)
            # Sadece SSH anahtarÄ±
            echo "AuthenticationMethods publickey" | sudo tee -a "$SSH_CUSTOM_CONF" > /dev/null
            ;;
        4)
            # SSH anahtarÄ± + 2FA (Ã¶nce SSH anahtarÄ±, sonra 2FA) - PAROLA YOK!
            echo "AuthenticationMethods publickey,keyboard-interactive" | sudo tee -a "$SSH_CUSTOM_CONF" > /dev/null
            ;;
    esac

    # SSH servisi iÃ§in gerekli dizinleri oluÅŸtur
    print_message "\nğŸ”§ SSH servisi iÃ§in gerekli dizinler oluÅŸturuluyor..." "$YELLOW"
    sudo mkdir -p /run/sshd
    sudo chmod 0755 /run/sshd

    # SSH host key'lerini oluÅŸtur (eÄŸer yoksa)
    if [[ ! -f /etc/ssh/ssh_host_ed25519_key ]]; then
        sudo ssh-keygen -A >/dev/null 2>&1 || true
    fi

    # SSH config testi
    print_message "ğŸ” SSH config test ediliyor..." "$YELLOW"
    if sudo sshd -t 2>&1; then
        print_message "âœ… SSH config testi baÅŸarÄ±lÄ±" "$GREEN"
    else
        print_message "âš ï¸  SSH config testinde uyarÄ±, dÃ¼zeltiliyor..." "$YELLOW"
        # Hata mesajÄ±nÄ± gÃ¶ster
        sudo sshd -t 2>&1 | grep -v "Warning" || true

        # Hata durumunda manuel dÃ¼zeltme yap
        sudo sed -i '/^Include/d' /etc/ssh/sshd_config
        echo "Include /etc/ssh/sshd_config.d/*.conf" | sudo tee -a /etc/ssh/sshd_config > /dev/null

        # Tekrar test et
        if sudo sshd -t 2>&1; then
            print_message "âœ… SSH config dÃ¼zeltildi ve test edildi" "$GREEN"
        else
            print_message "âš ï¸  SSH config testinde hata, ancak devam ediliyor..." "$RED"
        fi
    fi
}

# SSH anahtar yÃ¶netimi
manage_ssh_keys() {
    if [[ "$AUTH_CHOICE" == "3" || "$AUTH_CHOICE" == "4" ]]; then
        print_message "\nğŸ”‘ SSH ANAHTAR YÃ–NETÄ°MÄ°" "$CYAN"
        print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"

        # Sunucu hostname'ini al
        SERVER_HOSTNAME=$(hostname | cut -d'.' -f1 | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
        if [ -z "$SERVER_HOSTNAME" ]; then
            SERVER_HOSTNAME="server"
        fi

        KEY_NAME="$SERVER_HOSTNAME"
        IP_ADDRESS=$(hostname -I | awk '{print $1}')

        print_message "\nğŸ“‹ Ä°STEMCÄ° TARAFINDA YAPILACAKLAR:" "$YELLOW"
        print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"
        echo ""
        print_message "1. SSH anahtar Ã§ifti oluÅŸturun:" "$GREEN"
        print_message "   ssh-keygen -t ed25519 -f ~/.ssh/$KEY_NAME" "$CYAN"
        print_message "   (Parola kÄ±smÄ±nÄ± boÅŸ bÄ±rakabilirsiniz - sadece Enter'a basÄ±n)" "$YELLOW"
        echo ""
        print_message "2. Private key izinlerini ayarlayÄ±n:" "$GREEN"
        print_message "   chmod 600 ~/.ssh/$KEY_NAME" "$CYAN"
        echo ""
        print_message "3. Public key iÃ§eriÄŸini gÃ¶rÃ¼ntÃ¼leyin:" "$GREEN"
        print_message "   cat ~/.ssh/$KEY_NAME.pub" "$CYAN"
        echo ""
        print_message "4. AÅŸaÄŸÄ±daki satÄ±ra public key iÃ§eriÄŸini KOPYALAYIP YAPIÅTIRIN:" "$RED"
        print_message "(TÃ¼m satÄ±rÄ± kopyalayÄ±n, ENTER + Ctrl+D ile bitirin)" "$BLUE"
        print_message "Ã–rnek format: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI..." "$YELLOW"
        echo ""
        print_message "âš ï¸  DÄ°KKAT: Public key'i doÄŸru kopyaladÄ±ÄŸÄ±nÄ±zdan emin olun!" "$RED"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        # Public key alma dÃ¶ngÃ¼sÃ¼ - DOÄRU KEY GÄ°RÄ°LENE KADAR DEVAM ET
        while true; do
            print_message "ğŸ“‹ PUBLIC KEY Ä°Ã‡ERÄ°ÄÄ°NÄ° YAPIÅTIRIN (ENTER + Ctrl+D ile bitirin):" "$GREEN"
            print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"

            # Public key'i oku (birden fazla satÄ±r olabilir)
            PUBLIC_KEY=""
            while IFS= read -r line; do
                if [[ -n "$line" ]]; then
                    PUBLIC_KEY+="$line"$'\n'
                fi
            done

            # Trim whitespace (baÅŸtaki ve sondaki boÅŸluklarÄ± temizle)
            PUBLIC_KEY=$(echo "$PUBLIC_KEY" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

            # SSH key formatÄ±nÄ± kontrol et
            if [[ -n "$PUBLIC_KEY" ]] && [[ "$PUBLIC_KEY" =~ ^(ssh-(ed25519|rsa|dss|ecdsa)|ecdsa-sha2-nistp(256|384|521)|sk-(ssh-ed25519|ecdsa-sha2-nistp256)) ]]; then
                print_message "\nâœ… PUBLIC KEY FORMATI DOÄRU" "$GREEN"
                print_message "Key tipi: $(echo "$PUBLIC_KEY" | awk '{print $1}')" "$CYAN"

                # .ssh dizinini oluÅŸtur
                sudo -u "$NEW_USER" mkdir -p "/home/$NEW_USER/.ssh" 2>/dev/null || true

                # authorized_keys dosyasÄ±na ekle (append)
                echo "$PUBLIC_KEY" | sudo -u "$NEW_USER" tee -a "/home/$NEW_USER/.ssh/authorized_keys" > /dev/null

                # Ä°zinleri ayarla
                sudo chmod 700 "/home/$NEW_USER/.ssh" 2>/dev/null || true
                sudo chmod 600 "/home/$NEW_USER/.ssh/authorized_keys" 2>/dev/null || true
                sudo chown -R "$NEW_USER:$NEW_USER" "/home/$NEW_USER/.ssh" 2>/dev/null || true

                # Key parmak izini al
                KEY_FINGERPRINT=$(echo "$PUBLIC_KEY" | ssh-keygen -lf - 2>/dev/null | awk '{print $2}' || echo "Bilinmiyor")

                print_message "\nâœ… PUBLIC KEY BAÅARIYLA KAYDEDÄ°LDÄ°" "$GREEN"
                print_message "â€¢ Dosya: /home/$NEW_USER/.ssh/authorized_keys" "$CYAN"
                print_message "â€¢ Key parmak izi: $KEY_FINGERPRINT" "$CYAN"

                log_message "Public key eklendi: $(echo "$PUBLIC_KEY" | awk '{print $1}') - $KEY_FINGERPRINT"
                break  # BaÅŸarÄ±lÄ±, dÃ¶ngÃ¼den Ã§Ä±k

            else
                print_message "\nâŒ GEÃ‡ERSÄ°Z PUBLIC KEY FORMATI!" "$RED"
                print_message "LÃ¼tfen aÅŸaÄŸÄ±daki formatlardan birini kullandÄ±ÄŸÄ±nÄ±zdan emin olun:" "$YELLOW"
                print_message "â€¢ ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI..." "$GREEN"
                print_message "â€¢ ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC..." "$GREEN"
                print_message "â€¢ ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAI..." "$GREEN"
                print_message "" "$NC"

                if [[ -n "$PUBLIC_KEY" ]]; then
                    print_message "GirdiÄŸiniz key (ilk 50 karakter):" "$BLUE"
                    echo "\"${PUBLIC_KEY:0:50}...\""
                else
                    print_message "GirdiÄŸiniz key BOÅ!" "$RED"
                fi

                print_message "" "$NC"
                print_message "LÃ¼tfen tekrar deneyin..." "$YELLOW"
                echo ""
            fi
        done

        # BaÄŸlantÄ± testi iÃ§in komut gÃ¶ster
        print_message "\nğŸ”— BAÄLANTI TESTÄ°:" "$CYAN"
        print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"
        print_message "SSH anahtarÄ±nÄ±zla baÄŸlantÄ±yÄ± test edin:" "$GREEN"
        print_message "ssh -p $SSH_PORT -i ~/.ssh/$KEY_NAME $NEW_USER@$IP_ADDRESS" "$YELLOW"

        if check_internet; then
            PUBLIC_IP=$(curl -s --connect-timeout 3 icanhazip.com 2>/dev/null || echo "")
            if [[ -n "$PUBLIC_IP" ]]; then
                print_message "veya:" "$BLUE"
                print_message "ssh -p $SSH_PORT -i ~/.ssh/$KEY_NAME $NEW_USER@$PUBLIC_IP" "$YELLOW"
            fi
        fi

        # 2FA ile birlikte kullanÄ±lacaksa ek bilgi
        if [[ "$AUTH_CHOICE" == "4" ]]; then
            print_message "\nğŸ“± 2FA NOTU:" "$CYAN"
            print_message "BaÄŸlantÄ± sÄ±rasÄ±nda SSH anahtarÄ±nÄ±zdan sonra Google Authenticator kodu istenecektir." "$YELLOW"
        fi
    fi
}

# SSH servisini yeniden baÅŸlat
restart_ssh_service() {
    print_message "\nğŸ”„ SSH SERVÄ°SÄ° YENÄ°DEN BAÅLATILIYOR" "$CYAN"
    print_message "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" "$BLUE"

    sudo systemctl restart ssh >> "$LOG_FILE" 2>&1
    sudo systemctl enable ssh >> "$LOG_FILE" 2>&1

    print_message "âœ… SSH servisi yeniden baÅŸlatÄ±ldÄ±" "$GREEN"
}
